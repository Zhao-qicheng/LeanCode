# LeanCode 环境配置说明

## ✅ 环境配置已完成

### 📦 已安装的依赖

所有必需的依赖库已成功安装在 `leancode` conda 环境中：

| 库名 | 版本 | 用途 |
|------|------|------|
| Python | 3.11.5 | 编程语言 |
| PyTorch | 2.0.1 (CUDA 11.7) | 深度学习框架 |
| Transformers | 4.25.1 | HuggingFace模型库 |
| NumPy | 1.23.5 | 数值计算 |
| tqdm | 4.64.1 | 进度条 |
| TensorBoard | 2.11.2 | 训练可视化 |
| thop | 0.1.1 | 模型参数计算 |
| gdown | 4.6.0 | Google Drive下载 |
| scikit-learn | 1.3.0 | 机器学习工具 |

### 🎮 GPU 信息

- **GPU数量**: 2块
- **GPU型号**: NVIDIA GeForce RTX 4090
- **显存**: 每块 24GB
- **CUDA版本**: 11.7

## 🚀 如何使用

### 1. 激活环境

每次使用前，需要先激活conda环境：

```bash
conda activate leancode
```

### 2. 验证环境

运行验证脚本确认环境配置正确：

```bash
python verify_env.py
```

### 3. 下载数据集

按照README.md中的说明下载数据集：

```bash
# 创建数据目录
mkdir -p data/codesearch data/code2nl

# 下载代码搜索数据集
cd data/codesearch
gdown https://drive.google.com/uc?id=1xgSR34XO8xXZg4cZScDYj2eGerBE9iGo
unzip codesearch_data.zip
rm codesearch_data.zip

# 下载代码摘要数据集
cd ../code2nl
gdown https://drive.google.com/uc?id=1rd2Tc6oUWBo7JouwexW3ksQ0PaOhUr6h
unzip Cleaned_CodeSearchNet.zip
rm Cleaned_CodeSearchNet.zip
cd ../..

# 准备SlimCode测试数据
cd slimcode
mkdir -p data/codesearch data/code2nl
cd ..
python utils/process_slimcode.py
gunzip data/codesearch/java_test_0.jsonl.gz
python codesearch/process_data.py
```

### 4. 开始训练

#### 代码搜索任务 (CodeBERT)

```bash
python3 codesearch/run_classifier.py \
  --model_type roberta \
  --tokenizer_name microsoft/codebert-base \
  --model_name_or_path microsoft/codebert-base \
  --task_name codesearch \
  --do_train --do_eval \
  --prune_strategy None \
  --output_dir ./models/codesearch/codebert/base \
  --data_dir ./data/codesearch/train_valid/java \
  --train_file train.txt \
  --dev_file valid.txt \
  --max_seq_length 512 \
  --per_gpu_train_batch_size 64 \
  --per_gpu_eval_batch_size 64 \
  --learning_rate 1e-5 \
  --num_train_epochs 4 \
  --lang java \
  --gradient_accumulation_steps 1 \
  --overwrite_output_dir
```

#### 代码摘要任务 (CodeT5)

```bash
python code2nl/CodeT5/run_gen.py \
  --model_type codet5 \
  --task summarize \
  --sub_task java \
  --tokenizer_name Salesforce/codet5-base \
  --model_name_or_path Salesforce/codet5-base \
  --do_train --do_eval --do_eval_bleu \
  --prune_strategy None \
  --data_num -1 \
  --num_train_epochs 8 \
  --warmup_steps 1000 \
  --learning_rate 5e-5 \
  --patience 2 \
  --data_dir ./data/code2nl/CodeSearchNet/java \
  --cache_path ./models/code2nl/codet5/base/cache_data \
  --output_dir ./models/code2nl/codet5/base \
  --save_last_checkpoints \
  --always_save_model \
  --res_dir ./models/code2nl/codet5/base/prediction \
  --res_fn ./models/code2nl/codet5/base/result.txt \
  --train_batch_size 96 \
  --eval_batch_size 96 \
  --max_source_length 512 \
  --max_target_length 128 \
  --summary_dir ./models/code2nl/codet5/base/tensorboard
```

### 5. 使用命令生成器

项目提供了便捷的命令生成工具：

```bash
# 示例：CodeBERT + LeanCode策略 + 40%剪枝率
python utils/gen_cmd.py \
  --task_type codesearch \
  --model_type codebert \
  --prune_strategy leancode \
  --prune_ratio 40

# 基础实验（不剪枝）
python utils/gen_cmd.py \
  --task_type codesearch \
  --model_type codebert \
  --prune_strategy None
```

**参数说明**：
- `task_type`: `codesearch` (代码搜索) 或 `code2nl` (代码摘要)
- `model_type`: `codebert` 或 `codet5`
- `prune_strategy`: `leancode`, `slimcode`, `dietcode`, `leancode_d`, 或 `None`
- `prune_ratio`: `10`, `20`, `30`, `40`, `50` (百分比)

## 💡 常用命令

```bash
# 激活环境
conda activate leancode

# 退出环境
conda deactivate

# 查看已安装的包
pip list

# 检查GPU状态
nvidia-smi

# 查看环境列表
conda env list
```

## 📝 注意事项

1. **首次使用模型**：首次运行时会从HuggingFace自动下载CodeBERT和CodeT5模型，需要网络连接
2. **多GPU训练**：项目会自动使用所有可用GPU进行训练
3. **内存管理**：如果遇到OOM错误，可以减小batch_size
4. **数据路径**：确保数据集路径与命令中的路径一致

## 🔧 故障排除

### 问题1: CUDA out of memory
**解决方案**: 减小batch size
```bash
--per_gpu_train_batch_size 32  # 从64降低到32
```

### 问题2: 模型下载失败
**解决方案**: 
1. 检查网络连接
2. 或手动下载模型到本地后指定路径

### 问题3: 找不到数据文件
**解决方案**: 
1. 检查数据集是否正确下载和解压
2. 验证文件路径是否正确

## 📚 参考资源

- [项目README](README.md)
- [PyTorch文档](https://pytorch.org/docs/stable/index.html)
- [Transformers文档](https://huggingface.co/docs/transformers)
- [CodeBERT](https://huggingface.co/microsoft/codebert-base)
- [CodeT5](https://huggingface.co/Salesforce/codet5-base)

---

**环境配置完成时间**: 2025-10-22  
**配置者**: AI助手

